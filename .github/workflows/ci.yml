name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-import:
    name: Lint & Import Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install API deps + core deps (skip heavy GPU packages)
          pip install \
            fastapi==0.115.0 \
            "uvicorn[standard]==0.32.0" \
            python-multipart==0.0.19 \
            opencv-python-headless \
            "numpy>=1.23.5,<2" \
            insightface==0.7.3 \
            "onnx==1.18.0" \
            onnxruntime \
            torch --index-url https://download.pytorch.org/whl/cpu

      - name: Check Python syntax
        run: python -m py_compile api.py

      - name: Verify API imports
        run: |
          python -c "
          import sys, types
          # Stub modules.core (needs tensorflow in full install)
          stub = types.ModuleType('modules.core')
          stub.update_status = lambda msg, scope='': None
          sys.modules['modules.core'] = stub
          from api import app
          print('API imports OK')
          "

      - name: Verify endpoints registered
        run: |
          python -c "
          import sys, types
          stub = types.ModuleType('modules.core')
          stub.update_status = lambda msg, scope='': None
          sys.modules['modules.core'] = stub
          from api import app
          routes = [r.path for r in app.routes]
          assert '/' in routes, 'Missing root route'
          assert '/health' in routes, 'Missing /health'
          assert '/swap' in routes, 'Missing /swap'
          assert '/swap/video' in routes, 'Missing /swap/video'
          assert '/job/{job_id}' in routes, 'Missing /job/{job_id}'
          assert '/job/{job_id}/download' in routes, 'Missing /job/{job_id}/download'
          print(f'All endpoints registered: {routes}')
          "

  api-test:
    name: API Integration Test
    runs-on: ubuntu-latest
    needs: lint-and-import

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            fastapi==0.115.0 \
            "uvicorn[standard]==0.32.0" \
            python-multipart==0.0.19 \
            httpx \
            opencv-python-headless \
            "numpy>=1.23.5,<2" \
            insightface==0.7.3 \
            "onnx==1.18.0" \
            onnxruntime \
            torch --index-url https://download.pytorch.org/whl/cpu

      - name: Start server and test health
        run: |
          mkdir -p models
          python -m uvicorn api:app --host 127.0.0.1 --port 8000 &
          sleep 10

          # Health endpoint should return JSON
          HEALTH=$(curl -sf http://127.0.0.1:8000/health)
          echo "Health: $HEALTH"
          echo "$HEALTH" | python -c "import sys,json; d=json.load(sys.stdin); assert d['status'] in ('ok','degraded'), f'Bad status: {d}'"

          # Root should return HTML
          ROOT_STATUS=$(curl -sf -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/)
          echo "Root status: $ROOT_STATUS"
          [ "$ROOT_STATUS" = "200" ] || exit 1

          # Swap without model should return 500 (model not loaded)
          # Create a minimal test image (1x1 pixel)
          python -c "
          import cv2, numpy as np
          img = np.zeros((100,100,3), dtype=np.uint8)
          cv2.imwrite('/tmp/test.jpg', img)
          "
          SWAP_STATUS=$(curl -sf -o /dev/null -w '%{http_code}' -X POST http://127.0.0.1:8000/swap \
            -F "source=@/tmp/test.jpg" -F "target=@/tmp/test.jpg" || true)
          echo "Swap status (no model): $SWAP_STATUS"
          # 400 (no face) or 500 (model not loaded) are both acceptable
          [ "$SWAP_STATUS" = "400" ] || [ "$SWAP_STATUS" = "500" ] || exit 1

          echo "All tests passed"
